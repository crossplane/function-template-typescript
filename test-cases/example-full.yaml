---
name: Full Example
description: Test most input fields

xrPath: examples/app/example-full.yaml

expected:
  resourceCount: 4
  resourceTypes:
    - ServiceAccount
    - Service
    - Deployment
    - Ingress

  resources:
    serviceaccount:
      kind: ServiceAccount
      apiVersion: v1
      metadata:
        name: my-service-account
        labels:
          app.kubernetes.io/name: example-full
          app.kubernetes.io/instance: example-full
          app.kubernetes.io/managed-by: crossplane
        annotations:
          crossplane.io/composition-resource-name: serviceaccount
          eks.amazonaws.com/role-arn: "arn:aws:iam::123456789012:role/my-role"
      automountServiceAccountToken: true

    service:
      kind: Service
      apiVersion: v1
      metadata:
        labels:
          app.kubernetes.io/name: example-full
          app.kubernetes.io/instance: example-full
          app.kubernetes.io/managed-by: crossplane
        annotations:
          crossplane.io/composition-resource-name: service
      spec:
        type: ClusterIP
        ports:
          - port: 80
            targetPort: http
            protocol: TCP
            name: http
        selector:
          app.kubernetes.io/name: example-full
          app.kubernetes.io/instance: example-full

    deployment:
      kind: Deployment
      apiVersion: apps/v1
      metadata:
        labels:
          app.kubernetes.io/name: example-full
          app.kubernetes.io/instance: example-full
          app.kubernetes.io/managed-by: crossplane
        annotations:
          crossplane.io/composition-resource-name: deployment
          prometheus.io/scrape: "true"
          prometheus.io/port: "80"
      spec:
        replicas: 2
        selector:
          matchLabels:
            app.kubernetes.io/name: example-full
            app.kubernetes.io/instance: example-full
        template:
          metadata:
            labels:
              app.kubernetes.io/name: example-full
              app.kubernetes.io/instance: example-full
              environment: production
              tier: frontend
            annotations:
              prometheus.io/scrape: "true"
              prometheus.io/port: "80"
          spec:
            serviceAccountName: my-service-account
            securityContext:
              fsGroup: 2000
            nodeSelector:
              kubernetes.io/arch: amd64
              node-type: compute
            tolerations:
              - key: "dedicated"
                operator: "Equal"
                value: "gpu"
                effect: "NoSchedule"
            affinity:
              nodeAffinity:
                requiredDuringSchedulingIgnoredDuringExecution:
                  nodeSelectorTerms:
                    - matchExpressions:
                        - key: kubernetes.io/arch
                          operator: In
                          values:
                            - amd64
            volumes:
              - name: config-volume
                configMap:
                  name: my-config
              - name: secret-volume
                secret:
                  secretName: my-secret
                  optional: false
            containers:
              - name: example-full
                image: nginx:1.21
                imagePullPolicy: IfNotPresent
                ports:
                  - name: http
                    containerPort: 80
                    protocol: TCP
                securityContext:
                  capabilities:
                    drop:
                      - ALL
                  readOnlyRootFilesystem: true
                  runAsNonRoot: true
                  runAsUser: 1000
                resources:
                  limits:
                    cpu: 500m
                    memory: 512Mi
                  requests:
                    cpu: 100m
                    memory: 128Mi
                livenessProbe:
                  httpGet:
                    path: /healthz
                    port: http
                  initialDelaySeconds: 30
                  periodSeconds: 10
                readinessProbe:
                  httpGet:
                    path: /ready
                    port: http
                  initialDelaySeconds: 5
                  periodSeconds: 5
                volumeMounts:
                  - name: config-volume
                    mountPath: "/etc/config"
                    readOnly: true
                  - name: secret-volume
                    mountPath: "/etc/secrets"
                    readOnly: true

    ingress:
      kind: Ingress
      apiVersion: networking.k8s.io/v1
      metadata:
        labels:
          app.kubernetes.io/name: example-full
          app.kubernetes.io/instance: example-full
          app.kubernetes.io/managed-by: crossplane
        annotations:
          crossplane.io/composition-resource-name: ingress
          kubernetes.io/ingress.class: nginx
          kubernetes.io/tls-acme: "true"
          cert-manager.io/cluster-issuer: "letsencrypt-prod"
      spec:
        ingressClassName: nginx
        rules:
          - host: chart-example.local
            http:
              paths:
                - path: /
                  pathType: ImplementationSpecific
                  backend:
                    service:
                      name: example-full
                      port:
                        number: 80
          - host: api.example.com
            http:
              paths:
                - path: /api
                  pathType: Prefix
                  backend:
                    service:
                      name: example-full
                      port:
                        number: 80
